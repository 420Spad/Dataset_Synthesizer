<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.8"/>
<title>NVIDIA DeepLearning Dataset Synthesizer (NDDS): DL Deploy Scripts</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
  $(window).load(resizeHeight);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td style="padding-left: 0.5em;">
   <div id="projectname">NVIDIA DeepLearning Dataset Synthesizer (NDDS)
   </div>
  </td>
   <td>        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
</td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.8 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('ngc.html','');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Classes</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Namespaces</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Typedefs</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Pages</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">DL Deploy Scripts </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><hr/>
<p> <a class="anchor" id="contents"></a> </p><h1>Contents:</h1>
<ul>
<li><a href="#summary">Summary</a></li>
<li><a href="#template">Writing a JSON template for an NGC job</a></li>
<li><a href="#deploy">Deploying a job to NGC</a></li>
<li><a href="#results">Inspecting the results</a></li>
</ul>
<hr/>
<p> <a class="anchor" id="summary"></a> </p><h1>Summary</h1>
<p>(<a href="#contents">Back to Contents</a>)</p>
<p>DLToolkit provides some simple scripts that help automate deployment of jobs to NGC, the new name for NVIDIA's DGX cluster, formerly known as SaturnV.</p>
<p>These instructions assume that you have created an account with NGC, can successfully log into the NGC portal, and have installed the ngc client tools on your local machine. Comprehensive instructions on all of these steps can be found in the <a href="https://docs.google.com/document/d/1kDdYTrEfhmpvTFCAtfw_Ad-KPHSoTv34PaLqL21Tipc/edit#heading=h.mhenbrggudtd">NGC User Guide</a>.</p>
<p>Jobs deployed to NGC can be templatized as a single JSON file that can be launched via the NGC client tools. DLToolkit provides a primary helper script <code>execDlJob.sh</code> that extends the basic NGC template to auomate upload of datasets to NGC and capture of the resulting dataset ids, to simply the process.</p>
<p>NB: In the notes that follow, commands like <code>ngc batch get $id</code> refer to the unix NGC command-line client tool <code>ngc</code>. Using this tool, as well as the DLToolkit scripts, requires that you first log in to NGC, and set an NGC context. Notes for doing this can be found in the NGC User Guide.</p>
<hr/>
<p> <a class="anchor" id="template"></a> </p><h1>Writing a JSON template for an NGC Job</h1>
<p>(<a href="#contents">Back to Contents</a>)</p>
<p>A sample JSON file for deploying a DLAA job is given below:</p>
<p>```javascript { "dockerImageName": "nvidian/nvs-dlaa-tensorflow:18.05-py3", "aceName": "nv-us-west-2", "name": "DLAA_test", "publishedContainerPorts": [ 6006 ], "aceId": 257, "command": "cd /DLTrainer; python DLTrainer.py trainerconfig=/dltkcfg/Trainer_Config.json",</p>
<h1>These are comments &ndash; does the script support them?</h1>
<p>"datasetMounts": [ { "containerMountPoint": "/DLTrainer", "id": 10601, "localPath": "/mnt/DLTrainer/trainer/DLTrainer", "name": "DLTrainer", "version": "1.0.0.0", "forceUpload": false }, { "containerMountPoint": "/raid/apatney/work/dl-data/SIGGRAPH", "id": 10574, "localPath": "/mnt/emltest/DLAA/TrainingData", "name": "DLAATrainingData", "version": "1.0.0.0", "forceUpload": false }, { "containerMountPoint": "/src", "id": 10644, "localPath": "./src", "name" : "DLAATrainingSource", "version" : "1.0.0.3", "forceUpload":false }, { "containerMountPoint": "/dltkcfg", "id": 10643, "localPath": "./dltkcfg", "name" : "DLTCFG", "version" : "1.0.0.3", "forceUpload":false } ], "resultContainerMountPoint": "/results", "aceInstance": "ngcv8" } ```</p>
<p>The most important section for general job deployment is:</p>
<ul>
<li><p class="startli"><b>datasetMounts</b></p>
<p class="startli">These are the primary JSON blocks that you will be modifying when you deploy different runs to NGC. They define the datasets you will use, and the mount points within the docker image on NGC at which those datasets will appear.</p>
<p class="startli">Note that everything you upload to NGC is considered a "dataset" (i.e., source code, training data, etc)</p>
<p class="startli">Thus in the example above, there is a block for the DLTrainer code that will deploy your networks, the training data that your networks will train on, the DLAA source code that is deployed by DLTrainer, and the DLTrainer config files themselves. We discuss each of these in turn:</p>
</li>
</ul>
<pre class="fragment"> * `"containerMountPoint": "/DLTrainer"` 

    You should not need to modify this block, unless the DLTrainer
    code is updated by the NVStudios group.  It refers to a
    specific version of the DLTrainer code, and establishes a
    standard mount point for the DLTrainer code within the
    container, that is referenced in the command executed in the
    container.


 * `"containerMountPoint": "/raid/apatney/work/dl-data/SIGGRAPH"`

    This block specifies a dataset containing the DLAA training
    data, and the mount point where that data should appear in the
    container.

    You will only need to change this if you want to train against
data that have not yet been uploaded to NGC.

    If you want to train against data that have already been
    uploaded to NGC, just set the **name** and **version** keys in
    this block to match the existing dataset you want to use.

    If you want to train against new that have not yet been
    uploaded to NGC, set the **localPath** to point to the
    local/network mount point where the data reside, update the
    **name** and **version** keywords, and the script will upload
    the data for you.  This may take a while.

    If you change the DLAA source code with a config.py that
    references a different path to your training data, you will
    have to change the **containerMountPoint** keyword to
    correspond to the path in your configuration.


 * `"containerMountPoint": "/src"` 

    This block specifies a dataset containing the version of the
    DLAA code to use when deploying networks.

    You will only need to change this block if you update the DLAA
    source code.

    If you want to run against a new branch, for example, set the
    **localPath** keyword to point to where the source code
    resides on your local machine, change the **name** and
    **version** tags, and the script will upload it for you as a
    new "dataset" and deploy the job against the newly uploaded
    dataset.

    NB: The name of the mount point ("/src" in this case) must
    correspond to the path used in your DLTrainer config files
    (see below).  You probably won't want to change this.


 * `"containerMountPoint": "/dltkcfg"`

    This block specifies the dataset containing the DLTrainer
    configuration file or files for the job you want to deploy.

    You will probably change this for every new job that you
    deploy -- the DLTrainer configuration specifies how each
    deployed networks should be configured.  These are the same
    configuration files you would use to configure DLTrainer for
    local runs.

    As an example, my local dltkcfg directory contains the following files:

    ```sh
    linux-box:~/docker_tests/dlaa_test/dltkcfg$ ls
    DLAA_Cmdline_Defaults.json  DLAA_Config.json  Trainer_Config.json
    linux-box:~/docker_tests/dlaa_test/dltkcfg$ cat Trainer_Config.json
    ```
    ```  javascript
    {
        "SL"      :
        {
            "Modules" : ["DLAA_Config.json"]
        }
    }
    ```
    ```sh
    linux-box:~/docker_tests/dlaa_test/dltkcfg$ cat DLAA_Config.json
    ```
    ```javascript
    {
        # These are all DLTrainer-specific arguments

        "Name"              : "DLAA",
        "Impl"              : "imgrst_recurrent_eml",
        "AddPath"           : ["/src", "/DLTrainer"],
        "PyPath"            : "/src",
        "ExeType"           : "python_cmdline",
        "DelaySec"          : 1.0,
        "OutputPath"        : "/results",
        "GpuTag"            : "gpu",
        "ModOutputTag"      : "output",

        # Timeout after 5 minutes

        "TimeoutSec"        : 300,

        # These are user-defined (in this case DLAA-specific) arguments

        "Config"            : {
            "Include"           : "DLAA_Cmdline_Defaults.json"
        },

        # Networks to run. These inherit all default parameters above, and override selected parameter values

        "Networks"          : [{"Config" : {"gpu" : 0, "batch-size" : 4,  "nb-epoch" : 10}},
                               {"Config" : {"gpu" : 1, "batch-size" : 8,  "time-batch-size" : 4}},
                               {"Config" : {"gpu" : 2, "batch-size" : 16, "crop-size" : 128}},
                               {"Config" : {"gpu" : 3, "batch-size" : 32}},
                               {"Config" : {"gpu" : 4, "batch-size" : 5}},
                               {"Config" : {"gpu" : 5, "batch-size" : 9}},
                               {"Config" : {"gpu" : 6, "batch-size" : 17}},
                               {"Config" : {"gpu" : 7, "batch-size" : 33}}]
    }
    ```

Note that the config file references mount points inside the
container ("/src", "/DLTrainer", "/results") which must match
the mount points set up in the corresponding sections for
those datasets.
</pre><p>Other keywords you probably won't need to change:</p>
<ul>
<li><p class="startli"><b>dockerImageName</b></p>
<p class="startli">The name of the docker image in which to deploy your tests. Creating and uploading your own docker images is beyond the scope of this document, but you can list available images in the NGC registry by typing <code>ngc registry repo list</code> and associated commands. The example script refers to a docker image appropriate for running the generalization_april1018 branch of the DLAA git repo, and you shouldn't have to change it.</p>
</li>
<li><p class="startli"><b>aceName</b> and <b>aceId</b></p>
<p class="startli">These refer to specific compute regions, and you can leave them alone. Note however, that the region must correspond to the context you set via the <code>ngc context set</code> command. For instance, <code>ngc context set -o "nvidian" -a "nv-us-west-2"</code></p>
</li>
<li><p class="startli"><b>command</b></p>
<p class="startli">This is the commandline that will be executed in the container. These notes assume that you will be using DLTrainer to deploy your training on the NGC node, and you should not need to modify the command.</p>
</li>
<li><p class="startli"><b>resultContainerMountPoint</b></p>
<p class="startli">This is the mount point within NGC where your results will be written to. You probably won't want to change this, and note that it is also referenced in the DLTrainer config files (<b>OutputPath</b> tag, above), which must match whatever this is set to.</p>
</li>
</ul>
<hr/>
<p> <a class="anchor" id="deploy"></a> </p><h1>Deploying a job to NGC</h1>
<p>(<a href="#contents">Back to Contents</a>)</p>
<p>Once your NGC JSON file is set up the way you want it, the DLToolkit script <code>execDlJob.sh</code> handles submission to NGC. Running:</p>
<p>```sh sudo execDlJob.sh -s ngc $myjsonfile ```</p>
<p>if successful, should produce output like:</p>
<p>```sh Setting ngc output format to json. NGC Service location [<a href="https://api.ngc.nvidia.com">https://api.ngc.nvidia.com</a>] Successfully saved NGC configuration to /home/eleitch-local/.ngc/config</p>
<p>Running batch with ngcJob.tmp.json [{ "aceId": 257, "aceName": "nv-us-west-2", "aceProvider": "NGN", "createdDate": "2018-06-26T20:52:04.000Z", "id": 71509, "jobDefinition": { "aceId": 257, "command": "cd /DLTrainer; python DLTrainer.py trainerconfig=/dltkcfg/Trainer_Config.json", "datasetMounts": [ { "containerMountPoint": "/src",</p>
<pre class="fragment">...
</pre><p> }] Setting ngc output format to ascii. NGC Service location [<a href="https://api.ngc.nvidia.com">https://api.ngc.nvidia.com</a>] Successfully saved NGC configuration to /home/eleitch-local/.ngc/config ```</p>
<p>You can then view your job id and status in the NGC web portal (<a href="https://ngc.nvidia.com/dashboard">https://ngc.nvidia.com/dashboard</a>).</p>
<hr/>
<p> <a class="anchor" id="resutls"></a> </p><h1>Inspecting NGC results</h1>
<p>(<a href="#contents">Back to Contents</a>)</p>
<p>When your job is finished, you can retrieve the results via the ngc client:</p>
<p>```sh ngc result download $jobid ```</p>
<p>For example, if your jobid is 70808:</p>
<p>```sh linux-box:~/docker_tests/dlaa_test$ ngc result download 70808 409 files to download, total size - 357.41 MB Downloaded 6.63 MB, 34 files in 10s Download speed: 1.63 MB/s ... Downloaded 377.06 MB, 403 files in 33s Download speed: 6.69 MB/s </p><hr/>
<p> Result: 70808 Download status: Completed. Downloaded local path: /home/eleitch-local/docker_tests/dlaa_test/70808 Total files downloaded: 409 Total downloaded size: 377.44 MB Started at: 2018-06-26 13:59:41.110706 Completed at: 2018-06-26 14:00:15.094029 Duration taken: 33s seconds </p><hr/>
<p>linux-box:~/docker_tests/dlaa_test$ ls -l 70808 total 3188 drwxrwxr-x 3 eleitch-local eleitch-local 4096 Jun 26 13:59 2018-06-25T22_52_23.940195 -rw-rw-r&ndash; 1 eleitch-local eleitch-local 3259708 Jun 26 13:59 joblog.log ```</p>
<p>The results of the networks configured above are located under the timestamped output directory created by DLTrainer when it deployed your config:</p>
<p>```sh linux-box:~/docker_tests/dlaa_test$ ls -l 70808/2018-06-25T22_52_23.940195/DLAA/ total 32 drwxrwxr-x 3 eleitch-local eleitch-local 4096 Jun 26 13:59 Network_0 drwxrwxr-x 3 eleitch-local eleitch-local 4096 Jun 26 13:59 Network_1 drwxrwxr-x 3 eleitch-local eleitch-local 4096 Jun 26 13:59 Network_2 drwxrwxr-x 3 eleitch-local eleitch-local 4096 Jun 26 14:00 Network_3 drwxrwxr-x 3 eleitch-local eleitch-local 4096 Jun 26 14:00 Network_4 drwxrwxr-x 3 eleitch-local eleitch-local 4096 Jun 26 14:00 Network_5 drwxrwxr-x 3 eleitch-local eleitch-local 4096 Jun 26 14:00 Network_6 drwxrwxr-x 3 eleitch-local eleitch-local 4096 Jun 26 14:00 Network_7 ``` </p>
</div></div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated on Mon Jul 2 2018 10:26:35 for NVIDIA DeepLearning Dataset Synthesizer (NDDS) by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.8 </li>
  </ul>
</div>
</body>
</html>
